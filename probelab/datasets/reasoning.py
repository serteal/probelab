"""
Math and reasoning datasets.

These datasets provide mathematical problems with chain-of-thought reasoning,
useful for training probes to detect reasoning patterns in model outputs.
"""

from ..types import Dialogue, Message
from .hf_dataset import DatasetSpec, HFDataset
from .registry import register


def _build_math_with_messages_fallback(item: dict) -> Dialogue:
    """Builder for math datasets that support both problem/solution and messages format."""
    problem = item.get("problem", "")
    solution = item.get("solution", "")

    # Fallback to messages format if problem is empty
    if not problem:
        messages = item.get("messages", [])
        if messages:
            for msg in messages:
                if msg.get("role") == "user":
                    problem = msg.get("content", "")
                elif msg.get("role") == "assistant":
                    solution = msg.get("content", "")

    if not problem:
        return []

    dialogue: Dialogue = [Message(role="user", content=problem)]
    if solution:
        dialogue.append(Message(role="assistant", content=solution))
    return dialogue


@register("reasoning", "OpenR1 math reasoning")
class OpenR1MathDataset(HFDataset):
    """
    OpenR1-Math-220k: Large-scale math reasoning dataset.

    Contains 220K math problems with chain-of-thought reasoning traces
    generated by DeepSeek R1, verified using Math Verify.

    Source: https://huggingface.co/datasets/open-r1/OpenR1-Math-220k

    Configurations: "default" (94k), "extended" (131k), "all" (225k)

    Metadata fields:
        - problem_type: Classification of the problem
        - source: Origin dataset (e.g., NuminaMath, cn_k12)
        - answer: The final answer
    """

    base_name = "openr1_math"
    spec = DatasetSpec(
        hf_path="open-r1/OpenR1-Math-220k",
        hf_config="default",
        shape="custom",
        builder_fn=_build_math_with_messages_fallback,
        metadata_fields={
            "problem_type": ("problem_type",),
            "source": ("source",),
            "answer": ("answer",),
        },
    )


@register("reasoning", "OpenMath reasoning")
class OpenMathReasoningDataset(HFDataset):
    """
    OpenMathReasoning dataset from NVIDIA.

    Contains 306K math problems from AoPS forums with solutions
    generated by DeepSeek-R1 and QwQ-32B.

    Source: https://huggingface.co/datasets/nvidia/OpenMathReasoning

    Metadata fields:
        - problem_source: Origin of the problem
    """

    base_name = "openmath_reasoning"
    spec = DatasetSpec(
        hf_path="nvidia/OpenMathReasoning",
        shape="fields",
        user_fields=("problem", "question", "input"),
        assistant_fields=("solution", "response", "output"),
        metadata_fields={
            "problem_source": ("source",),
        },
    )


@register("reasoning", "Numina math chain-of-thought")
class NuminaMathCoTDataset(HFDataset):
    """
    NuminaMath Chain-of-Thought dataset.

    Contains 860K+ math competition problems with step-by-step solutions.

    Source: https://huggingface.co/datasets/AI-MO/NuminaMath-CoT

    Metadata fields:
        - source: Origin of the problem
    """

    base_name = "numina_math"
    spec = DatasetSpec(
        hf_path="AI-MO/NuminaMath-CoT",
        shape="custom",
        builder_fn=_build_math_with_messages_fallback,
        metadata_fields={
            "source": ("source",),
        },
    )


@register("reasoning", "Enhanced math instructions")
class MathInstructEnhancedDataset(HFDataset):
    """
    Enhanced MathInstruct dataset from TIGER-Lab.

    Contains mathematical instruction tuning examples with
    various problem types and step-by-step solutions.

    Source: https://huggingface.co/datasets/TIGER-Lab/MathInstruct

    Metadata fields:
        - source: Origin of the problem
    """

    base_name = "math_instruct_enhanced"
    spec = DatasetSpec(
        hf_path="TIGER-Lab/MathInstruct",
        shape="fields",
        user_fields=("instruction",),
        assistant_fields=("output",),
        metadata_fields={
            "source": ("source",),
        },
    )
